<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>WebAuthn Test Page</title>
  </head>
  <body style="padding: 20px;">
    <h1>WebAuthn Test</h1>
    <p id="supports"></p>
    <p id="secure"></p>

    <p>
      <span>Authenticator Type</span>
      <select id="authenticator">
        <option value="any" selected="selected">any</option>
        <option value="platform">platform - built into a device</option>
        <option value="cross-platform">cross-platform - USB, NFC, or BLE</option>
      </select>
    </p>

    <p>
      <span>Attestation Type</span>
      <select id="attestation">
        <option value="none" selected="none">none</option>
        <option value="indirect">indirect</option>
        <option value="direct">direct</option>
      </select>
    </p>

    <button onclick="attestation()">Attestation</button>
    <p id="attestation-res">Attestation?</p>
    <pre><code id="attestation-data"></code></pre>

    <p>ID: <code id="id"></code></p>

    <button onclick="assertion()">Assertion</button>
    <p id="assertion-res">Assertion?</p>
    <pre><code id="assertion-data"></code></pre>

    <script>
      function toUint8Array(value){
        return Uint8Array.from(value, c => c.charCodeAt(0));
      }

      function arrayBufferToJSON(buffer) {
        return JSON.parse(String.fromCharCode.apply(null, new Uint8Array(buffer)));
      }

      function arrayBufferToBase64URLString(buffer) {
        return btoa(String.fromCharCode.apply(null, buffer))
          .replace(/\+/g, '-')
          .replace(/\//g, '_')
          .replace(/=/g, '');
      }

      function selected(id) {
        const e = document.getElementById(id);
        return e.options[e.selectedIndex].value;
      }

      if (window.PublicKeyCredential !== undefined && typeof window.PublicKeyCredential === 'function') {
        document.getElementById('supports').textContent = 'WebAuthn supported';
      } else {
        document.getElementById('supports').textContent = 'WebAuthn not supported';
      }

      console.log('isSecureContext:', window.isSecureContext);

      if (window.isSecureContext === true) {
        document.getElementById('secure').textContent = 'Context is secure';
      } else {
        document.getElementById('secure').textContent = 'Context is not secure';
      }

      let id;

      async function attestation() {
        const challenge = new Uint8Array(16);
        window.crypto.getRandomValues(challenge);
        console.log('attestation challenge:', arrayBufferToBase64URLString(challenge));

        const publicKeyCredentialCreationOptions = {
          challenge,
          rp: {
            name: 'Test Company',
          },
          user: {
            id: toUint8Array('12345'),
            name: 'user',
            displayName: 'User',
          },
          // YubiKeys currently support RS256 (Firmware 5.1.X and below only),
          // EdDSA, ES256, and Ed25519 (Firmware 5.2.X and above only).
          // Windows Hello only supports RS256 (alg -257) as its public key algorithm.
          pubKeyCredParams: [{
            'type': 'public-key',
            // ES256
            'alg': -7
          }, {
            'type': 'public-key',
            // ES384
            'alg': -35
          }, {
            'type': 'public-key',
            // ES512
            'alg': -36
          }, {
            'type': 'public-key',
            // PS256
            'alg': -37
          }, {
            'type': 'public-key',
            // PS384
            'alg': -38
          }, {
            'type': 'public-key',
            // PS512
            'alg': -39
          }, {
            'type': 'public-key',
            // EdDSA
            'alg': -8
          }, {
            'type': 'public-key',
            // RS256 (not recommended)
            'alg': -257
          }, {
            'type': 'public-key',
            // RS384 (not recommended)
            'alg': -258
          }, {
            'type': 'public-key',
            // RS512 (not recommended)
            'alg': -259
          }],
          attestation: selected('attestation'),
        };

        const authenticator = selected('authenticator');
        if (authenticator !== 'any') {
          publicKeyCredentialCreationOptions.authenticatorSelection = {
            authenticatorAttachment: authenticator,
          };
        }

        console.log('publicKeyCredentialCreationOptions:', publicKeyCredentialCreationOptions);

        try {
          const credential = await navigator.credentials.create({
            publicKey: publicKeyCredentialCreationOptions,
          });

          console.log('attestation:', credential);

          id = credential.rawId;

          document.getElementById('id').textContent = credential.id;
          document.getElementById('attestation-res').textContent = `Attestation supported, challenge: ${arrayBufferToBase64URLString(challenge)}`;
          document.getElementById('attestation-data').textContent = JSON.stringify(arrayBufferToJSON(credential.response.clientDataJSON), null, '  ');
        } catch (err) {
          console.error('attestation error:', err);

          document.getElementById('id').textContent = '';
          document.getElementById('attestation-res').textContent = `Attestation error: ${err.message}`;
          document.getElementById('attestation-data').textContent = err;
        }
      }

      async function assertion() {
        if (!id) {
          alert('You have to attestate first');
          return;
        }

        const challenge = new Uint8Array(16);
        window.crypto.getRandomValues(challenge);
        console.log('assertion challenge:', arrayBufferToBase64URLString(challenge));

        const publicKeyCredentialRequestOptions = {
          challenge,
          allowCredentials: [{
            id,
            type: 'public-key',
          }],
        };

        console.log('publicKeyCredentialRequestOptions:', publicKeyCredentialRequestOptions);

        try {
          const credential = await navigator.credentials.get({
            publicKey: publicKeyCredentialRequestOptions
          });

          console.log('assertion:', credential);

          document.getElementById('assertion-res').textContent = `Assertion supported, challenge: ${arrayBufferToBase64URLString(challenge)}`;
          document.getElementById('assertion-data').textContent = JSON.stringify(arrayBufferToJSON(credential.response.clientDataJSON), null, '  ');
        } catch (err) {
          console.error('assertion error:', err);

          document.getElementById('assertion-res').textContent = `Assertion error: ${err.message}`;
          document.getElementById('assertion-data').textContent = err;
        }
      }
    </script>
  </body>
</html>
